<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Discharge Summary - {{.PatientName}}</title>
  <style>
    @page {
      size: A4;
      margin: 15mm;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans', 'DejaVu Sans', Arial, sans-serif;
      font-size: 11px;
      line-height: 1.5;
      color: #1f2937;
      max-width: 180mm;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      border-bottom: 2px solid #2563eb;
      padding-bottom: 12px;
      margin-bottom: 16px;
    }
    .header h1 {
      font-size: 18px;
      color: #1e40af;
      margin-bottom: 2px;
    }
    .clinic-info {
      text-align: center;
      font-size: 10px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 13px;
      color: #1e40af;
      border-bottom: 1px solid #dbeafe;
      padding-bottom: 4px;
      margin: 16px 0 8px 0;
    }
    .info-grid {
      display: table;
      width: 100%;
    }
    .info-row {
      display: table-row;
    }
    .info-cell {
      display: table-cell;
      padding: 3px 8px;
      width: 50%;
    }
    .info-cell .label {
      color: #6b7280;
      font-size: 10px;
    }
    .info-cell .value {
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
      font-size: 10px;
    }
    th {
      padding: 6px 8px;
      text-align: left;
      background: #eff6ff;
      border-bottom: 2px solid #bfdbfe;
      font-size: 10px;
      color: #1e40af;
      text-transform: uppercase;
      font-weight: 600;
    }
    td {
      padding: 5px 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .improved { color: #16a34a; font-weight: 600; }
    .declined { color: #dc2626; font-weight: 600; }
    .neutral { color: #6b7280; }
    .mcid-met { color: #16a34a; font-weight: 700; }
    .section-content {
      padding: 4px 0;
      white-space: pre-wrap;
    }
    .exercise-list {
      margin: 4px 0;
    }
    .recommendation-item {
      margin: 4px 0;
      padding-left: 12px;
    }
    .recommendation-item::before {
      content: "\2022 ";
      color: #2563eb;
      font-weight: bold;
    }
    .priority-high { color: #dc2626; }
    .priority-medium { color: #d97706; }
    .priority-low { color: #16a34a; }
    .signature-area {
      display: table;
      width: 100%;
      margin-top: 40px;
    }
    .signature-cell {
      display: table-cell;
      width: 50%;
      text-align: center;
      vertical-align: top;
      padding: 0 20px;
    }
    .signature-line {
      border-top: 1px dashed #9ca3af;
      margin-top: 50px;
      padding-top: 8px;
    }
    .footer {
      text-align: center;
      color: #9ca3af;
      font-size: 9px;
      margin-top: 20px;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
    }
  </style>
</head>
<body>
  {{if .ClinicName}}
  <div class="clinic-info">
    <strong>{{.ClinicName}}</strong><br/>
    {{if .ClinicAddress}}{{.ClinicAddress}}<br/>{{end}}
    {{if .ClinicPhone}}Tel: {{.ClinicPhone}}{{end}}
  </div>
  {{end}}

  <div class="header">
    <h1>DISCHARGE SUMMARY</h1>
  </div>

  <h2>Patient Information</h2>
  <div class="info-grid">
    <div class="info-row">
      <div class="info-cell">
        <span class="label">Name:</span>
        <span class="value">{{.PatientName}}</span>
      </div>
      <div class="info-cell">
        <span class="label">MRN:</span>
        <span class="value">{{.PatientMRN}}</span>
      </div>
    </div>
    <div class="info-row">
      <div class="info-cell">
        <span class="label">Date of Birth:</span>
        <span class="value">{{.PatientDOB}}</span>
      </div>
      <div class="info-cell">
        <span class="label">Treatment Period:</span>
        <span class="value">{{.DateRange}}</span>
      </div>
    </div>
    <div class="info-row">
      <div class="info-cell">
        <span class="label">Total Sessions:</span>
        <span class="value">{{.TotalSessions}}</span>
      </div>
      <div class="info-cell">
        <span class="label">Therapist:</span>
        <span class="value">{{.TherapistName}}</span>
      </div>
    </div>
  </div>

  <h2>Diagnosis & Treatment Summary</h2>
  <p><strong>Diagnosis:</strong></p>
  <div class="section-content">{{.Diagnosis}}</div>

  <p style="margin-top: 8px;"><strong>Treatment Summary:</strong></p>
  <div class="section-content">{{.TreatmentSummary}}</div>

  {{if .BaselineComparisons}}
  <h2>Outcome Measures</h2>
  <table>
    <thead>
      <tr>
        <th>Measure</th>
        <th class="text-center">Baseline</th>
        <th class="text-center">Discharge</th>
        <th class="text-center">Change</th>
        <th class="text-center">MCID Met</th>
      </tr>
    </thead>
    <tbody>
      {{range .BaselineComparisons}}
      <tr>
        <td>{{.MeasureName}}</td>
        <td class="text-center">{{printf "%.1f" .BaselineValue}}</td>
        <td class="text-center" style="font-weight: 600;">{{printf "%.1f" .FinalValue}}</td>
        <td class="text-center {{if gt .Change 0.0}}improved{{else if lt .Change 0.0}}declined{{else}}neutral{{end}}">
          {{if gt .Change 0.0}}+{{end}}{{printf "%.1f" .Change}}
          ({{if gt .ChangePercent 0.0}}+{{end}}{{printf "%.1f" .ChangePercent}}%)
        </td>
        <td class="text-center">
          {{if .MeetsMCID}}<span class="mcid-met">Yes</span>{{else}}-{{end}}
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
  {{end}}

  <h2>Functional Status at Discharge</h2>
  <div class="section-content">{{.FunctionalStatus}}</div>

  {{if .HomeProgram}}
  <h2>Home Exercise Program</h2>
  {{if .HomeProgram.Exercises}}
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Exercise</th>
        <th class="text-center">Sets</th>
        <th class="text-center">Reps</th>
        <th class="text-center">Hold (sec)</th>
      </tr>
    </thead>
    <tbody>
      {{range $i, $e := .HomeProgram.Exercises}}
      <tr>
        <td>{{inc $i}}</td>
        <td>
          {{$e.Name}}
          {{if $e.Instructions}}
          <br/><span style="font-size: 9px; color: #6b7280;">{{$e.Instructions}}</span>
          {{end}}
        </td>
        <td class="text-center">{{$e.Sets}}</td>
        <td class="text-center">{{$e.Reps}}</td>
        <td class="text-center">{{if gt $e.HoldSeconds 0}}{{$e.HoldSeconds}}{{else}}-{{end}}</td>
      </tr>
      {{end}}
    </tbody>
  </table>
  <p style="font-size: 10px; margin-top: 4px;">
    <strong>Frequency:</strong> {{.HomeProgram.Frequency}} |
    <strong>Duration:</strong> {{.HomeProgram.Duration}}
  </p>
  {{if .HomeProgram.Instructions}}
  <p style="font-size: 10px; margin-top: 4px;">
    <strong>Instructions:</strong> {{.HomeProgram.Instructions}}
  </p>
  {{end}}
  {{end}}
  {{end}}

  {{if .Recommendations}}
  <h2>Recommendations</h2>
  {{range .Recommendations}}
  <div class="recommendation-item">
    <span class="priority-{{.Priority}}">[{{.Priority}}]</span>
    {{.Description}}
  </div>
  {{end}}
  {{end}}

  {{if .FollowUp}}
  {{if .FollowUp.IsNeeded}}
  <h2>Follow-up Plan</h2>
  <div class="info-grid">
    {{if gt .FollowUp.IntervalWeeks 0}}
    <div class="info-row">
      <div class="info-cell">
        <span class="label">Interval:</span>
        <span class="value">Every {{.FollowUp.IntervalWeeks}} weeks</span>
      </div>
      {{if gt .FollowUp.TotalVisits 0}}
      <div class="info-cell">
        <span class="label">Total Visits:</span>
        <span class="value">{{.FollowUp.TotalVisits}}</span>
      </div>
      {{end}}
    </div>
    {{end}}
  </div>
  {{if .FollowUp.Reason}}
  <p style="margin-top: 4px;"><strong>Reason:</strong> {{.FollowUp.Reason}}</p>
  {{end}}
  {{if .FollowUp.ReferralTo}}
  <p style="margin-top: 4px;"><strong>Referral To:</strong> {{.FollowUp.ReferralTo}}</p>
  {{end}}
  {{end}}
  {{end}}

  <h2>Prognosis</h2>
  <div class="section-content">{{.Prognosis}}</div>

  <div class="signature-area">
    <div class="signature-cell">
      <p style="color: #6b7280; font-size: 10px;">Date: _______________</p>
      <div class="signature-line">
        <p><strong>Patient</strong></p>
      </div>
    </div>
    <div class="signature-cell">
      <p style="color: #6b7280; font-size: 10px;">Date: _______________</p>
      <div class="signature-line">
        <p><strong>{{.TherapistName}}</strong></p>
        <p style="color: #6b7280; font-size: 10px;">Physical Therapist</p>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>This document was auto-generated by PhysioFlow EMR - {{.GeneratedAt}}</p>
  </div>
</body>
</html>
