apiVersion: apps/v1
kind: Deployment
metadata:
  name: physioflow-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: physioflow
      component: api
  template:
    metadata:
      labels:
        app: physioflow
        component: api
    spec:
      initContainers:
        - name: db-migrate
          image: registry.trancloud.work/physioflow-api:latest
          command: ["sh", "-c", "echo 'Migration placeholder - implement migrate command'; exit 0"]
          envFrom:
            - configMapRef:
                name: physioflow-config
            - secretRef:
                name: physioflow-secrets
      containers:
        - name: api
          image: registry.trancloud.work/physioflow-api:latest
          ports:
            - containerPort: 8080
          envFrom:
            - configMapRef:
                name: physioflow-config
            - configMapRef:
                name: feature-flags
            - secretRef:
                name: physioflow-secrets
          volumeMounts:
            - name: service-codes
              mountPath: /app/config/service-codes.json
              subPath: service-codes.json
              readOnly: true
            - name: clinical-protocols
              mountPath: /app/config/protocols.json
              subPath: protocols.json
              readOnly: true
            - name: outcome-measures
              mountPath: /app/config/measures.json
              subPath: measures.json
              readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
      volumes:
        - name: service-codes
          configMap:
            name: pt-service-codes
        - name: clinical-protocols
          configMap:
            name: clinical-protocols
        - name: outcome-measures
          configMap:
            name: outcome-measures-library
