apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: physioflow-alerts
  labels:
    app: physioflow
    prometheus: main
spec:
  groups:
    - name: physioflow.bhyt
      interval: 30s
      rules:
        - alert: BHYTHighErrorRate
          expr: |
            (
              sum(rate(bhyt_validation_errors_total[5m]))
              /
              sum(rate(bhyt_validations_total[5m]))
            ) > 0.05
          for: 5m
          labels:
            severity: warning
            component: bhyt
            feature: insurance
          annotations:
            summary: "High BHYT validation error rate"
            description: "BHYT validation error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/bhyt-high-error-rate"

        - alert: BHYTCoverageCalculationSlow
          expr: bhyt_coverage_p95_duration_ms > 1000
          for: 5m
          labels:
            severity: warning
            component: bhyt
            feature: insurance
          annotations:
            summary: "BHYT coverage calculation is slow"
            description: "BHYT coverage calculation p95 latency is {{ $value }}ms (threshold: 1000ms)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/bhyt-slow-calculation"

    - name: physioflow.outcome_measures
      interval: 30s
      rules:
        - alert: OutcomeMeasuresSlowCalculation
          expr: outcome_progress_p95_duration_ms > 1000
          for: 5m
          labels:
            severity: warning
            component: outcome-measures
            feature: clinical
          annotations:
            summary: "Outcome measures calculation is slow"
            description: "Outcome progress calculation p95 latency is {{ $value }}ms (threshold: 1000ms)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/outcome-measures-slow"

    - name: physioflow.billing
      interval: 30s
      rules:
        - alert: BillingCalculationErrors
          expr: |
            (
              rate(billing_calculation_errors_total[5m])
              /
              rate(billing_invoices_created_total[5m])
            ) > 0.01
          for: 5m
          labels:
            severity: critical
            component: billing
            feature: billing
          annotations:
            summary: "High billing calculation error rate"
            description: "Billing calculation error rate is {{ $value | humanizePercentage }} (threshold: 1%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/billing-errors"

    - name: physioflow.discharge
      interval: 30s
      rules:
        - alert: DischargePDFGenerationSlow
          expr: discharge_pdf_p95_duration_ms > 5000
          for: 5m
          labels:
            severity: warning
            component: discharge
            feature: clinical
          annotations:
            summary: "Discharge PDF generation is slow"
            description: "Discharge PDF generation p95 latency is {{ $value }}ms (threshold: 5000ms)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/discharge-pdf-slow"

    - name: physioflow.medical_terms
      interval: 30s
      rules:
        - alert: MedicalTermSearchSlow
          expr: medical_terms_search_p95_duration_ms > 500
          for: 5m
          labels:
            severity: warning
            component: medical-terms
            feature: clinical
          annotations:
            summary: "Medical term search is slow"
            description: "Medical term search p95 latency is {{ $value }}ms (threshold: 500ms)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/medical-terms-slow"

    - name: physioflow.api
      interval: 30s
      rules:
        - alert: APIHighErrorRate
          expr: |
            (
              sum(rate(api_requests_total{status=~"5xx"}[5m]))
              /
              sum(rate(api_requests_total[5m]))
            ) > 0.05
          for: 5m
          labels:
            severity: critical
            component: api
          annotations:
            summary: "High API error rate"
            description: "API 5xx error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/api-high-error-rate"

        - alert: APIHighLatency
          expr: |
            histogram_quantile(0.95,
              sum(rate(api_request_duration_seconds_bucket[5m])) by (le, endpoint)
            ) > 2
          for: 5m
          labels:
            severity: warning
            component: api
          annotations:
            summary: "High API latency on {{ $labels.endpoint }}"
            description: "API p95 latency is {{ $value }}s (threshold: 2s)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/api-high-latency"

    - name: physioflow.database
      interval: 30s
      rules:
        - alert: DatabaseConnectionPoolExhausted
          expr: |
            (
              pg_stat_activity_count
              /
              pg_settings_max_connections
            ) > 0.9
          for: 5m
          labels:
            severity: critical
            component: database
          annotations:
            summary: "Database connection pool near exhaustion"
            description: "Database connection usage is {{ $value | humanizePercentage }} (threshold: 90%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/db-connection-pool"

        - alert: DatabaseSlowQueries
          expr: |
            rate(pg_stat_statements_calls{queryid=~".*"}[5m]) > 1
            and
            pg_stat_statements_mean_exec_time_seconds > 1
          for: 10m
          labels:
            severity: warning
            component: database
          annotations:
            summary: "Database has slow queries"
            description: "Query {{ $labels.queryid }} average execution time is {{ $value }}s"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/db-slow-queries"

    - name: physioflow.protocols
      interval: 30s
      rules:
        - alert: ProtocolAssignmentFailureRate
          expr: |
            (
              rate(api_requests_total{endpoint=~".*protocols/assign.*",status="5xx"}[5m])
              /
              rate(api_requests_total{endpoint=~".*protocols/assign.*"}[5m])
            ) > 0.05
          for: 5m
          labels:
            severity: warning
            component: protocols
            feature: clinical
          annotations:
            summary: "High protocol assignment failure rate"
            description: "Protocol assignment error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/protocol-assignment-errors"

    - name: physioflow.cache
      interval: 30s
      rules:
        - alert: RedisCacheDown
          expr: up{job="redis"} == 0
          for: 2m
          labels:
            severity: critical
            component: cache
          annotations:
            summary: "Redis cache is down"
            description: "Redis cache has been down for more than 2 minutes"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/redis-down"

        - alert: CacheHitRateLow
          expr: |
            (
              rate(redis_keyspace_hits_total[5m])
              /
              (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))
            ) < 0.8
          for: 10m
          labels:
            severity: warning
            component: cache
          annotations:
            summary: "Low Redis cache hit rate"
            description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 80%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/cache-hit-rate-low"

    - name: physioflow.security
      interval: 30s
      rules:
        - alert: HighAuthenticationFailureRate
          expr: |
            (
              rate(api_requests_total{status="401"}[5m])
              /
              rate(api_requests_total[5m])
            ) > 0.1
          for: 5m
          labels:
            severity: warning
            component: security
          annotations:
            summary: "High authentication failure rate"
            description: "Authentication failure rate is {{ $value | humanizePercentage }} (threshold: 10%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/auth-failures"

        - alert: SuspiciousActivityDetected
          expr: |
            rate(api_requests_total{status="403"}[5m]) > 10
          for: 5m
          labels:
            severity: critical
            component: security
          annotations:
            summary: "Suspicious activity: High rate of forbidden requests"
            description: "{{ $value }} forbidden requests per second detected"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/suspicious-activity"

    - name: physioflow.availability
      interval: 30s
      rules:
        - alert: APIHighLatencyP99
          expr: |
            avg(api_request_duration_p99_ms) > 3000
          for: 10m
          labels:
            severity: warning
            component: api
          annotations:
            summary: "API p99 latency is very high"
            description: "API p99 latency is {{ $value }}ms (threshold: 3000ms)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/api-p99-latency"

        - alert: APIServiceDown
          expr: up{job="physioflow-api"} == 0
          for: 1m
          labels:
            severity: critical
            component: api
          annotations:
            summary: "PhysioFlow API is down"
            description: "PhysioFlow API has been down for more than 1 minute"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/api-down"

        - alert: HighMemoryUsage
          expr: |
            (
              container_memory_usage_bytes{pod=~"physioflow-api-.*"}
              /
              container_spec_memory_limit_bytes{pod=~"physioflow-api-.*"}
            ) > 0.9
          for: 5m
          labels:
            severity: warning
            component: infrastructure
          annotations:
            summary: "High memory usage on {{ $labels.pod }}"
            description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 90%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/high-memory"

        - alert: HighCPUUsage
          expr: |
            rate(container_cpu_usage_seconds_total{pod=~"physioflow-api-.*"}[5m]) > 0.8
          for: 10m
          labels:
            severity: warning
            component: infrastructure
          annotations:
            summary: "High CPU usage on {{ $labels.pod }}"
            description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)"
            runbook_url: "https://wiki.trancloud.work/physioflow/runbooks/high-cpu"
